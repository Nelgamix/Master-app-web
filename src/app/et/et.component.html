<div class="container contenu">
  <div class="row mb-2">
    <div class="col-md-7 col-sm-12">
      <span class="align-middle ade-status" *ngIf="etService.metadata['ok']" style="color: green;">OK</span>
      <span class="align-middle ade-status" *ngIf="!etService.metadata['ok']" style="color: red;">NON OK</span>

      <span class="align-middle ade-status" *ngIf="etService.metadata['adeOnline']" style="color: green;">ADE est en ligne!</span>
      <span class="align-middle ade-status" *ngIf="!etService.metadata['adeOnline']" style="color: red;">ADE est hors-ligne!</span>

      <span class="align-middle last-updated">Dernière mise à jour <b>{{etService.metadata['lastUpdated'] | amTimeAgo}}</b></span>
    </div>
    <div class="col-md-5 col-sm-12">
      <div class="form-row" id="form-selection-date">
        <div class="col-auto">
          <button class="btn btn-danger mr-2" (click)="nowWeek()">&#8630;</button>
          <button class="btn btn-secondary" (click)="previousWeek()">&lArr;</button>
        </div>
        <div class="col-auto">
          <select [(ngModel)]="selectedDate" (ngModelChange)="onChangeDate($event)" class="custom-select form-control" name="selDate" id="selDate">
            <option [ngValue]="i" *ngFor="let i of datesService.semaines">{{i.debut | amDateFormat:'YYYY-MM-DD'}} &rarr; {{i.fin | amDateFormat:'YYYY-MM-DD'}}</option>
          </select>
        </div>
        <div class="col-auto">
          <button class="btn btn-secondary" (click)="nextWeek()">&rArr;</button>
        </div>
      </div>
    </div>
  </div>

  <div *ngIf="!etService.metadata['ok']" class="row mt-5">
    <div class="col text-center">
      <h2>ADE est hors-ligne, et les données n'ont pas été enregistrées sur la BD, donc retente plus tard&hellip;</h2>
      <h3 class="text-muted">Peut être que le chargement depuis le serveur a échoué, essaye d'actualiser la page si tu viens d'arriver</h3>
    </div>
  </div>

  <ng-container *ngIf="etService.metadata['ok']">
    <div class="row mb-2 pt-2 pb-2" id="head-title">
      <div class="col">
        <div class="row">
          <div class="col h3 week-header mb-1">
            Semaine du <span class="text-primary">{{datesService.semaineSelectionnee.debut | amDateFormat:'D MMMM YYYY'}}</span>
            au <span class="text-primary">{{datesService.semaineSelectionnee.fin | amDateFormat:'D MMMM YYYY'}}</span>
          </div>
        </div>

        <div class="row">
          <div class="col h6 week-header mb-1" [ngSwitch]="infoSemaine.placement">
            <span *ngSwitchCase="-1">Dans {{infoSemaine.date | amDuration:'milliseconds'}}</span>
            <span *ngSwitchCase="0">Commencée depuis {{infoSemaine.date | amDuration:'milliseconds'}}</span>
            <span *ngSwitchCase="1">Finie depuis {{infoSemaine.date | amDuration:'milliseconds'}}</span>
          </div>
        </div>

        <div class="row">
          <div class="col">
            <ngb-progressbar type="info" [value]="weekProgress" [striped]="true"><b>{{weekProgress | number:'1.0-1'}}%</b></ngb-progressbar>
          </div>
        </div>
      </div>
    </div>

    <div class="row mt-4" *ngIf="etService.emploiTemps.cours.length == 0; else elseBlock">
      <div class="col text-center">
        <h3>Aucun cours cette semaine.</h3>
      </div>
    </div>

    <ng-template #elseBlock>
      <div class="row">
        <div class="col-md-7 col-sm-12 heading">
          <div class="row">
            <div class="col-md-4 col-sm-12 mb-2">
              <h5>Statistiques</h5>
              <div class="row">
                <div class="col-12">
                  <span class="stat-donnee">{{etService.emploiTemps.stats['duree'].value | duree}}</span> heures
                </div>
              </div>
              <div class="row">
                <div class="col-12">
                  <span class="stat-donnee">{{etService.emploiTemps.stats['moyenneCours'].value | duree}}</span> heure(s) / cours
                </div>
              </div>
              <div class="row">
                <div class="col-12">
                  <span class="stat-donnee">{{etService.emploiTemps.stats['moyenneJours'].value | duree}}</span> heures / jour
                </div>
              </div>
              <div class="row">
                <div class="col-12">
                  <button type="button" class="btn btn-success take-width mt-2" (click)="openStats()">Autres stats</button>
                </div>
              </div>
              <div class="row mt-2">
                <div class="col">
                  <div class="btn-group btn-group-toggle take-width" ngbRadioGroup name="radioBasic" [(ngModel)]="vueType">
                    <label ngbButtonLabel class="btn-primary take-width">
                      <input ngbButton type="radio" [value]="1"> Tables
                    </label>
                    <label ngbButtonLabel class="btn-primary take-width">
                      <input ngbButton type="radio" [value]="2"> Visuel
                    </label>
                  </div>
                </div>
              </div>
            </div>

            <div class="col-md-8 col-sm-12 mb-2">
              <h5>Exclusions</h5>
              <div class="row" *ngFor="let e of (exclusions ? exclusions.slice(0, 5) : [])">
                <div class="col-12">
                  <b class="capitalize">{{e.type}}</b>: {{e.contient}} <span style="font-style: italic" *ngIf="e.supprime">[Hidden]</span>
                </div>
              </div>
              <div class="row" *ngIf="exclusions.length > 5">
                <div class="col-12">
                  &hellip; + <b>{{exclusions.length - 5}}</b> éléments
                </div>
              </div>
              <div class="row mt-2">
                <div class="col">
                  <button class="btn btn-warning take-width" (click)="openExclusions()">Configurer</button>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="col heading">
          <h5>Début &amp; fin des cours</h5>
          <table style="width: 85%; margin: auto auto 10px;">
            <tbody>
            <ng-container *ngFor="let j of etService.emploiTemps.jours">
              <tr *ngIf="j && j.duree.asMinutes() > 0">
                <td><span class="stat-titre">{{j.nom}}</span></td>
                <td style="text-align: right"><span class="stat-donnee">{{j.premierCours.debut | date: 'HH:mm'}} &rarr; {{j.dernierCours.fin | date: 'HH:mm'}}</span></td>
              </tr>
            </ng-container>
            </tbody>
          </table>
          <div>
            <dl>
              <dt *ngIf="etService.coursActuel">Cours actuel</dt>
              <dd *ngIf="etService.coursActuel">{{etService.coursActuel.nom}} en <span *ngFor="let s of etService.coursActuel.salles">{{s.batiment}} {{s.salle}}</span></dd>

              <dt *ngIf="etService.prochainCours">Cours suivant</dt>
              <dd *ngIf="etService.prochainCours">{{etService.prochainCours.nom}} en <span *ngFor="let s of etService.prochainCours.salles">{{s.batiment}} {{s.salle}}</span></dd>
            </dl>
          </div>
        </div>
      </div>

      <ng-container [ngSwitch]="vueType">
        <app-et-table *ngSwitchCase="1"></app-et-table>
        <app-et-visuel *ngSwitchCase="2"></app-et-visuel>
      </ng-container>
    </ng-template>
  </ng-container>
</div>

<div class="loader" *ngIf="loading">
  <h1>Chargement...</h1>
</div>
