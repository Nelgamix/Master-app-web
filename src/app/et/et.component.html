<div class="container contenu">
  <ng-container *ngIf="!info">
    <div class="row mb-2">
      <div class="col-md-7 col-sm-12">
        <span class="align-middle ade-status" *ngIf="etService.metadata['ok']" style="color: green;">OK</span>
        <span class="align-middle ade-status" *ngIf="!etService.metadata['ok']" style="color: red;">NON OK</span>

        <span class="align-middle ade-status" *ngIf="etService.metadata['adeOnline']" style="color: green;">ADE est en ligne!</span>
        <span class="align-middle ade-status" *ngIf="!etService.metadata['adeOnline']" style="color: red;">ADE est hors-ligne!</span>

        <span class="align-middle last-updated">Dernière mise à jour <b>{{etService.metadata['lastUpdated'] | amTimeAgo}}</b></span>
      </div>
      <div class="col-md-5 col-sm-12">
        <div class="form-row" id="form-selection-date">
          <div class="col-auto">
            <button class="btn btn-danger mr-2" (click)="nowWeek()">&#8630;</button>
            <button class="btn btn-secondary" (click)="previousWeek()">&lArr;</button>
          </div>
          <div class="col-auto">
            <select [(ngModel)]="selectedDate" (ngModelChange)="onChangeDate($event)" class="custom-select form-control" name="selDate" id="selDate">
              <option [ngValue]="i" *ngFor="let i of datesService.semaines">{{i.debut | amDateFormat:'YYYY-MM-DD'}} &rarr; {{i.fin | amDateFormat:'YYYY-MM-DD'}}</option>
            </select>
          </div>
          <div class="col-auto">
            <button class="btn btn-secondary" (click)="nextWeek()">&rArr;</button>
          </div>
          <div class="col-auto">
            <button class="btn btn-info" (click)="showInfo()">&#8693;</button>
          </div>
        </div>
      </div>
    </div>

    <div *ngIf="!etService.metadata['ok']" class="row mt-5">
      <div class="col text-center">
        <h2>ADE est hors-ligne, et les données n'ont pas été enregistrées sur la BD, donc retente plus tard&hellip;</h2>
        <h3 class="text-muted">Peut être que le chargement depuis le serveur a échoué, essaye d'actualiser la page si tu viens d'arriver</h3>
      </div>
    </div>

    <ng-container *ngIf="etService.metadata['ok'] && semaine">
      <div class="row mb-2 pt-2 pb-2" id="head-title">
        <div class="col">
          <div class="row">
            <div class="col h3 week-header mb-1">
              Semaine <span class="text-info">{{datesService.semaineSelectionnee.week}}</span>,
              du <span class="text-primary">{{datesService.semaineSelectionnee.debut | amDateFormat:'D MMMM YYYY'}}</span>
              au <span class="text-primary">{{datesService.semaineSelectionnee.fin | amDateFormat:'D MMMM YYYY'}}</span>
            </div>
          </div>

          <div class="row" *ngIf="infoSemaine">
            <div class="col h6 week-header mb-1" [ngSwitch]="infoSemaine.placement">
              <span *ngSwitchCase="-1">Dans {{infoSemaine.date | amDuration:'milliseconds'}}</span>
              <span *ngSwitchCase="0">Commencée depuis {{infoSemaine.date | amDuration:'milliseconds'}}</span>
              <span *ngSwitchCase="1">Finie depuis {{infoSemaine.date | amDuration:'milliseconds'}}</span>
            </div>
          </div>

          <div class="row">
            <div class="col">
              <ngb-progressbar type="info" [value]="weekProgress" [striped]="true"><b>{{weekProgress | number:'1.0-1'}}%</b></ngb-progressbar>
            </div>
          </div>
        </div>
      </div>

      <div class="row mt-4" *ngIf="semaine.cours.length === 0; else elseBlock">
        <div class="col text-center">
          <h3>Aucun cours cette semaine.</h3>
        </div>
      </div>

      <ng-template #elseBlock>
        <div class="row">
          <div class="col-md-7 col-sm-12 heading m-3">
            <div class="row">
              <div class="col-md-4 col-sm-12 mb-3 mb-md-0">
                <h5>Statistiques</h5>
                <div class="row">
                  <div class="col-12">
                    <span class="stat-donnee">{{semaine.stats['duree'].value | duree}}</span> heures
                  </div>
                </div>
                <div class="row">
                  <div class="col-12">
                    <span class="stat-donnee">{{semaine.stats['moyenneCours'].value | duree}}</span> heure(s) / cours
                  </div>
                </div>
                <div class="row">
                  <div class="col-12">
                    <span class="stat-donnee">{{semaine.stats['moyenneJours'].value | duree}}</span> heures / jour
                  </div>
                </div>
                <div class="row">
                  <div class="col-12">
                    <button type="button" class="btn btn-success take-width mt-2" (click)="openStats()"><img src="assets/icons/list.png" alt="Plus de statistiques"></button>
                  </div>
                </div>
              </div>

              <div class="col-md-8 col-sm-12 mb-2">
                <h5>Exclusions</h5>
                <div class="row" *ngFor="let e of (etService.exclusions ? etService.exclusions.slice(0, 5) : [])">
                  <div class="col-12">
                    <span *ngIf="e.supprimer"><i>[caché]</i></span>
                    <span *ngIf="e.type.length > 0"><b>Type</b>: {{e.type}}</span>
                    <span *ngIf="e.nom.length > 0"><b>Nom</b>: {{e.nom}}</span>
                    <span *ngIf="e.professeur.length > 0"><b>Prof.</b>: {{e.professeur}}</span>
                    <span *ngIf="e.salle.length > 0"><b>Salle</b>: {{e.salle}}</span>
                  </div>
                </div>
                <div class="row" *ngIf="etService.exclusions.length > 5">
                  <div class="col-12">
                    + <b>{{etService.exclusions.length - 5}}</b> éléments
                  </div>
                </div>
                <div class="row mt-2">
                  <div class="col">
                    <button class="btn btn-warning take-width" (click)="openExclusions()"><img src="assets/icons/pencil.png" alt="Configurer"></button>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="col heading m-3">
            <h5>Début &amp; fin des cours</h5>
            <div class="row">
              <div class="col">
                <div class="row" *ngFor="let j of semaine.jours">
                  <ng-container *ngIf="j && j.duree.asMinutes() > 0 && j.premierCours && j.dernierCours">
                    <div class="col-6 text-center">
                      <span class="stat-titre text-capitalize">{{j.date | amDateFormat:'dddd'}}</span>
                    </div>
                    <div class="col-6 text-center">
                      <span class="stat-donnee">{{j.premierCours.debut | date: 'HH:mm'}} &rarr; {{j.dernierCours.fin | date: 'HH:mm'}}</span>
                    </div>
                  </ng-container>
                </div>
              </div>
            </div>
            <hr *ngIf="etService.coursActuel || etService.prochainCours">
            <div class="row">
              <div class="col">
                <dl>
                  <dt *ngIf="etService.coursActuel">Cours actuel</dt>
                  <dd *ngIf="etService.coursActuel"><b>{{etService.coursActuel.nom}}</b> en <span class="font-italic" *ngFor="let s of etService.coursActuel.salles">{{s.batiment}} {{s.salle}}</span></dd>

                  <dt *ngIf="etService.prochainCours">Cours suivant <span style="font-size: 75%; color: gray">dans {{etService.prochainCoursTimer | amDuration:'milliseconds'}}</span></dt>
                  <dd *ngIf="etService.prochainCours"><b>{{etService.prochainCours.nom}}</b> en <span class="font-italic" *ngFor="let s of etService.prochainCours.salles">{{s.batiment}} {{s.salle}}</span></dd>
                </dl>
              </div>
            </div>
          </div>
        </div>

        <div class="row mb-2">
          <div class="col-md-6 col-sm-12">
            <div class="input-group">
              <div class="input-group-prepend">
                <span class="input-group-text" id="basic-search"><img src="assets/icons/search.png" alt="Recherche"></span>
              </div>
              <input type="text" class="form-control" placeholder="Rechercher" aria-label="Rechercher" aria-describedby="basic-search" [(ngModel)]="search">
              <div class="input-group-append" *ngIf="search.length > 0">
                <button type="button" class="btn btn-danger" (click)="search = ''"><img src="assets/icons/delete.png" alt="Clear"></button>
              </div>
            </div>
          </div>
          <div class="col-md-6 col-sm-12 mt-2 mt-md-0">
            <div class="float-right">
              <div class="btn-group btn-group-toggle" ngbRadioGroup name="radioBasic" [(ngModel)]="vueType">
                <label ngbButtonLabel class="btn-primary px-4">
                  <input ngbButton type="radio" [value]="1"><img src="assets/icons/options.png" alt="Tables">
                </label>
                <label ngbButtonLabel class="btn-primary px-4">
                  <input ngbButton type="radio" [value]="2"><img src="assets/icons/expand.png" alt="Visuel">
                </label>
              </div>
              <button type="button" class="btn btn-success img-text" (click)="openPersonnel()"><img src="assets/icons/push-pin.png" alt="Cours">Personnel</button>
              <button type="button" class="btn btn-warning img-text" (click)="openNotes()"><img src="assets/icons/file.png" alt="Notes">Notes</button>
              <button type="button" class="btn btn-info img-text" [ngbPopover]="helpContent" popoverTitle="Code couleur" placement="left">
                <img src="assets/icons/info.png" alt="Info">Couleurs
              </button>
            </div>
          </div>
        </div>

        <ng-container [ngSwitch]="vueType">
          <app-et-table *ngSwitchCase="1" [search]="search"></app-et-table>
          <app-et-visuel *ngSwitchCase="2"></app-et-visuel>
        </ng-container>
      </ng-template>
    </ng-container>
  </ng-container>
  <ng-container *ngIf="info">
    <button class="btn btn-dark float-left" (click)="info = false">&larr;</button>
    <h2 class="text-center">Informations sur l'emploi du temps</h2>
    <div class="alert alert-light">
      Cette page contient des informations sur l'emploi du temps, ainsi qu'un récapitulatif de ce qui est sauvegardé
      en base de donnée et des stats. <br>
      Ce contenu va s'enrichir au fil du temps.
    </div>
    <div class="row">
      <div class="col p-0" style="height: 300px">
        <ngx-charts-line-chart
          [scheme]="colorScheme"
          [results]="chartData"
          [xAxis]="true"
          [yAxis]="true"
          [showXAxisLabel]="true"
          [showYAxisLabel]="true"
          [xAxisLabel]="'Semaines'"
          [yAxisLabel]="'Nombre de cours'">
        </ngx-charts-line-chart>
      </div>
    </div>
    <div class="row mb-3" *ngFor="let s of etService.emploiTemps.semainesSelectionnees">
      <div class="col">
        <div class="row">
          <div class="col">
            <h4>Semaine {{s.week}} de {{s.year}}</h4>
          </div>
        </div>
        <div class="row">
          <div class="col">
            <b>Mis à jour le</b> {{s.updated}}
          </div>
          <div class="col">
            <b>Stats auto-calculés</b>: <!--{{s.stats === null ? 'Aucune' : 'Oui, ' + (s.stats | objet).length}}-->
          </div>
          <div class="col">
            <b>Nombre de cours</b>: {{s.cours.length}}
          </div>
        </div>
      </div>
    </div>
  </ng-container>
</div>

<div class="loader" *ngIf="loading">
  <h1>Chargement...</h1>
</div>

<ng-template #helpContent>
  <span class="demo-cm">CM</span>
  <span class="demo-td">TD</span>
  <span class="demo-tp">TP</span>
  <span class="demo-autre">Autre</span>
</ng-template>
